<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebXR 360 × Google Forms Runner</title>
  <!-- A‑Frame CDN -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    html, body { margin:0; height:100%; background:#000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", Meiryo, sans-serif; }
    #hud { position: fixed; inset: 0; display: grid; place-items: center; pointer-events: none; }
    .panel { background: rgba(10,10,10,.8); color:#fff; padding: 24px; border-radius: 16px; width: min(92vw, 760px); pointer-events: auto; }
    .row { display:flex; gap:12px; align-items:center; }
    label { display:block; margin:.25rem 0 .5rem; font-weight:600; }
    input, button, select { font-size: 16px; padding: 10px 12px; border-radius: 12px; border: 1px solid #444; background:#111; color:#fff; }
    button { cursor:pointer; border: 1px solid #666; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .stack { display:grid; gap:14px; }
    #status { position: fixed; left: 12px; bottom: 12px; color:#fff; opacity:.8; font-size: 14px; }
    #countdown { font-size: 28px; font-weight:700; text-align:center; }
    #formWrap { position: fixed; right: 10px; top: 10px; width: min(720px, 48vw); height: min(80vh, 720px); border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,.6); display:none; }
    #formFrame { width: 100%; height: 100%; border:0; background:#111; }
    #overlayMsg { text-align:center; font-size:18px; opacity:.9; }
    #progressBar { height: 8px; width:100%; background: #222; border-radius: 8px; overflow: hidden; }
    #bar { height:100%; width:0%; background: #4ade80; transition: width .2s linear; }
  </style>
</head>
<body>
  <!-- 360° Scene -->
  <a-scene renderer="colorManagement: true;" vr-mode-ui="enabled: true">
    <a-sky id="sky" src="#" rotation="0 0 0" ></a-sky>
    <a-entity position="0 1.6 0">
      <a-entity camera look-controls wasd-controls="enabled:false"></a-entity>
    </a-entity>
  </a-scene>

  <!-- HUD / UI -->
  <div id="hud" aria-live="polite">
    <div id="startPanel" class="panel stack">
      <h2>360° 提示 + フォーム評価 実験</h2>
      <p>説明：1枚目の提示から <b>10秒後</b> にGoogleフォームが開きます。<br>送信すると自動で次の画像に進み、全 <span id="totalSpan">16</span> 条件を評価します。</p>
      <div class="stack">
        <div>
          <label for="pid">被験者ID</label>
          <input id="pid" placeholder="例: S001" autocomplete="off" />
        </div>
        <div class="row">
          <div style="flex:1">
            <label for="seed">乱数シード（任意）</label>
            <input id="seed" placeholder="未入力なら自動" autocomplete="off" />
          </div>
          <div style="width: 180px">
            <label for="lockSec">提示ロック秒数</label>
            <select id="lockSec">
              <option value="10" selected>10秒</option>
              <option value="15">15秒</option>
              <option value="20">20秒</option>
            </select>
          </div>
        </div>
      </div>
      <button id="startBtn">開始</button>
      <small style="opacity:.7">Quest ブラウザで全画面にして実施してください。</small>
    </div>

    <div id="lockPanel" class="panel stack" style="display:none">
      <div id="overlayMsg">周囲を見回して観察してください。<br>フォームは <b><span id="secLeft">10</span> 秒</b> 後に表示されます。</div>
      <div id="progressBar"><div id="bar"></div></div>
      <div id="countdown">10</div>
      <div style="opacity:.7; text-align:center"><span id="imgLabel">Image 1 / 16</span></div>
    </div>
  </div>

  <!-- Google Form Iframe -->
  <div id="formWrap">
    <iframe id="formFrame" allow="clipboard-write *;" referrerpolicy="no-referrer"></iframe>
  </div>

  <div id="status"></div>

  <script>
    // =====================
    // ==== CONFIG AREA ====
    // =====================

    // TODO: ここに 16枚の360°画像URL（等距離長方形 equirectangular）を登録してください。
    // 例: 企業内ホスティング or CDN / GitHub Pages などに配置
    const IMAGES = [
      {name: 'img01', src: 'assets/360/img01.jpg'},
      {name: 'img02', src: 'assets/360/img02.jpg'},
      {name: 'img03', src: 'assets/360/img03.jpg'},
      {name: 'img04', src: 'assets/360/img04.jpg'},
      {name: 'img05', src: 'assets/360/img05.jpg'},
      {name: 'img06', src: 'assets/360/img06.jpg'},
      {name: 'img07', src: 'assets/360/img07.jpg'},
      {name: 'img08', src: 'assets/360/img08.jpg'},
      {name: 'img09', src: 'assets/360/img09.jpg'},
      {name: 'img10', src: 'assets/360/img10.jpg'},
      {name: 'img11', src: 'assets/360/img11.jpg'},
      {name: 'img12', src: 'assets/360/img12.jpg'},
      {name: 'img13', src: 'assets/360/img13.jpg'},
      {name: 'img14', src: 'assets/360/img14.jpg'},
      {name: 'img15', src: 'assets/360/img15.jpg'},
      {name: 'img16', src: 'assets/360/img16.jpg'},
    ];

    // TODO: Google フォームの「プレフィルURL（またはフォームURL）」に置き換えてください
    // 例: const GOOGLE_FORM_BASE = 'https://docs.google.com/forms/d/e/XXXXXXXXXXXX/viewform';
    const GOOGLE_FORM_BASE = 'https://docs.google.com/forms/d/e/REPLACE_WITH_YOUR_FORM_ID/viewform';

    // TODO: Googleフォームの各質問に対応する entry.X へのマッピング
    // 下記は例です。実際の entryID はフォームの「プレフィル」から控えてください。
    const FORM_ENTRIES = {
      pid: 'entry.1111111111',      // 被験者ID
      condition: 'entry.2222222222',// 条件番号（1..16）
      image: 'entry.3333333333',    // 画像名（ファイル名など）
      timestamp: 'entry.4444444444' // ページ遷移時刻
      // 以降、快適性などの評価項目は Google Form 側の設問に合わせてフォーム内で回答
    };

    // フォーム送信完了URLの一意な判定（Google側は formResponse に遷移する）
    const FORM_RESPONSE_KEYWORD = 'formResponse';

    // =====================
    // ====== APP LOGIC =====
    // =====================

    const sky = document.getElementById('sky');
    const hud = document.getElementById('hud');
    const startPanel = document.getElementById('startPanel');
    const lockPanel = document.getElementById('lockPanel');
    const startBtn = document.getElementById('startBtn');
    const pidInput = document.getElementById('pid');
    const seedInput = document.getElementById('seed');
    const lockSecSel = document.getElementById('lockSec');
    const secLeftEl = document.getElementById('secLeft');
    const countdownEl = document.getElementById('countdown');
    const imgLabel = document.getElementById('imgLabel');
    const status = document.getElementById('status');

    const formWrap = document.getElementById('formWrap');
    const formFrame = document.getElementById('formFrame');
    const bar = document.getElementById('bar');
    const totalSpan = document.getElementById('totalSpan');

    totalSpan.textContent = String(IMAGES.length);

    let order = [...IMAGES];
    let currentIndex = -1;
    let lockSeconds = 10;
    let pid = '';
    let timerId = null;
    let progId = null;

    // 乱数シード付きシャッフル（Fisher–Yates）
    function seededRandom(seed) {
      // xorshift32 的な簡易PRNG
      let x = seed >>> 0;
      return function() {
        x ^= x << 13; x >>>= 0;
        x ^= x >>> 17; x >>>= 0;
        x ^= x << 5;  x >>>= 0;
        return (x >>> 0) / 0xFFFFFFFF;
      }
    }
    function shuffle(arr, seedStr) {
      const a = [...arr];
      let rnd = Math.random;
      if (seedStr && seedStr.trim() !== '') {
        // シードは文字列からハッシュ生成
        let h = 2166136261;
        for (let i=0; i<seedStr.length; i++) {
          h ^= seedStr.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        rnd = seededRandom(h);
      }
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rnd() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function setSky(src) {
      sky.setAttribute('src', src);
    }

    function log(msg) {
      status.textContent = msg;
      console.log(msg);
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function buildPrefillURL(base, params) {
      const usp = new URLSearchParams();
      for (const [k,v] of Object.entries(params)) {
        usp.set(k, v);
      }
      // Google Forms は "viewform?usp=pp_url&entry.x=..." 形式でプレフィル
      const url = `${base}?usp=pp_url&${usp.toString()}`;
      return url;
    }

    function showLock(count) {
      hud.style.display = 'grid';
      startPanel.style.display = 'none';
      lockPanel.style.display = 'block';
      secLeftEl.textContent = String(count);
      countdownEl.textContent = String(count);
      formWrap.style.display = 'none';
      bar.style.width = '0%';
    }

    function showForm(url) {
      formFrame.src = url;
      formWrap.style.display = 'block';
    }

    function nextImage() {
      currentIndex++;
      if (currentIndex >= order.length) {
        // 完了
        hud.style.display = 'grid';
        lockPanel.innerHTML = '<div class="stack"><h2>完了しました。ご協力ありがとうございました。</h2><button onclick="location.reload()">最初に戻る</button></div>';
        formWrap.style.display = 'none';
        return;
      }
      const item = order[currentIndex];
      setSky(item.src);
      imgLabel.textContent = `Image ${currentIndex+1} / ${order.length}`;
      log(`Showing: ${item.name} (${currentIndex+1}/${order.length})`);
      // ロック → カウントダウン
      let remain = lockSeconds;
      showLock(remain);

      // プログレスバー
      let elapsed = 0;
      const total = remain;
      clearInterval(progId);
      progId = setInterval(() => {
        elapsed += 0.2; // 200msごと
        const pct = Math.min(100, (elapsed/total)*100);
        bar.style.width = pct + '%';
      }, 200);

      clearInterval(timerId);
      timerId = setInterval(() => {
        remain -= 1;
        secLeftEl.textContent = String(Math.max(0, remain));
        countdownEl.textContent = String(Math.max(0, remain));
        if (remain <= 0) {
          clearInterval(timerId);
          clearInterval(progId);
          // フォームを表示
          const params = {};
          params[FORM_ENTRIES.pid] = pid;
          params[FORM_ENTRIES.condition] = String(currentIndex+1);
          params[FORM_ENTRIES.image] = item.name;
          params[FORM_ENTRIES.timestamp] = nowIso();
          const url = buildPrefillURL(GOOGLE_FORM_BASE, params);
          showForm(url);
          hud.style.display = 'none';
        }
      }, 1000);
    }

    // フォームの送信完了（確認ページ遷移）を検知して次へ
    formFrame.addEventListener('load', () => {
      try {
        const loc = formFrame.contentWindow.location.href;
        if (loc.includes(FORM_RESPONSE_KEYWORD)) {
          // 次の画像へ
          formWrap.style.display = 'none';
          nextImage();
        }
      } catch(e) {
        // クロスオリジンで直接読めない場合があるので、URLの文字列取得だけ試行
        // 取得できない環境では、下記フォールバックを使う：
        // 1) Googleフォームの送信後に "次へ" ボタンをこのページに戻すリンクにする
        // 2) またはフォーム上に「次へ」ボタンを追加して、postMessageで通知
        console.warn('Could not read iframe URL due to cross-origin. Consider using confirmation page redirect back to this app.');
      }
    });

    // スタート
    startBtn.addEventListener('click', () => {
      pid = (pidInput.value || '').trim();
      lockSeconds = parseInt(lockSecSel.value, 10) || 10;
      const seedStr = (seedInput.value || '').trim();
      if (!pid) {
        alert('被験者IDを入力してください');
        return;
      }
      order = shuffle(IMAGES, seedStr);
      // URLパラメータでも seed 指定できる
      const usp = new URLSearchParams(location.search);
      const urlSeed = usp.get('seed');
      if (urlSeed && !seedStr) {
        order = shuffle(IMAGES, urlSeed);
      }
      // 1枚目へ
      nextImage();
    });

    // URL パラメータで pid 指定可（例: ?pid=S001&seed=abc）
    (function hydrateFromURL(){
      const usp = new URLSearchParams(location.search);
      const qpid = usp.get('pid');
      const qseed = usp.get('seed');
      const qlock = usp.get('lock');
      if (qpid) pidInput.value = qpid;
      if (qseed) seedInput.value = qseed;
      if (qlock) lockSecSel.value = String(qlock);
    })();

  </script>
</body>
</html>
