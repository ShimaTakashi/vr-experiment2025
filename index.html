<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VR Experiment (HDR)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- three r152系 HDR/EXR loaders（A-Frame1.5.0と相性良） -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/RGBELoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/EXRLoader.js"></script>

  <style>
    html,body{margin:0;height:100%;background:#000;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", Meiryo, sans-serif}
    #ui,#nextOverlay{
      position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:rgba(0,0,0,.85);color:#fff;z-index:9999
    }
    #ui input, #ui select{font-size:1.1rem;padding:.6rem .9rem;border-radius:.6rem;border:1px solid #444;background:#111;color:#fff}
    button{padding:.8rem 1.4rem;border:1px solid #666;background:#1a7f5a;color:#fff;border-radius:.6rem;font-size:1.1rem;cursor:pointer}
    #log{position:fixed;left:10px;bottom:10px;color:#0f0;background:rgba(0,0,0,.6);padding:.4rem .6rem;border-radius:.4rem;font:12px/1.3 monospace;z-index:10000;max-width:60vw;white-space:pre-wrap}
    #count{font-weight:700}
  </style>
</head>
<body>

<!-- スタートUI -->
<div id="ui">
  <h2>360° 提示 + フォーム評価 実験</h2>
  <p>説明：1枚目の提示から <b>10秒後</b> にGoogleフォームが開きます。<br>送信が終わるたびに次の画像へ進み、全 <span id="total">16</span> 条件を評価します。</p>
  <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
    <div><div>被験者ID</div><input id="pid" placeholder="例: S001"></div>
    <div><div>乱数シード（任意）</div><input id="seed" placeholder="未入力なら自動"></div>
    <div><div>提示ロック秒数</div>
      <select id="lock">
        <option value="10" selected>10秒</option>
        <option value="15">15秒</option>
        <option value="20">20秒</option>
      </select>
    </div>
  </div>
  <div style="margin-top:16px"><button id="start">開始</button></div>
  <small style="opacity:.7;margin-top:10px">Quest ブラウザで全画面にして実施してください。</small>
</div>

<!-- 回答促しUI（フォームは別タブで開く） -->
<div id="nextOverlay" style="display:none">
  <div style="text-align:center">
    <div style="font-size:1.2rem">Googleフォームに回答し、<b>送信</b>してください。</div>
    <div style="margin:.6rem 0 .9rem;opacity:.8">送信後、下のボタンで次の画像に進みます。</div>
    <button id="nextBtn">次へ</button>
  </div>
</div>

<!-- デバッグログ -->
<div id="log">log:</div>

<!-- A-Frameシーン：HDRが映える設定（トーンマッピング等） -->
<a-scene
  renderer="colorManagement: true; physicallyCorrectLights: true; toneMapping: ACESFilmic; toneMappingExposure: 1.0"
  vr-mode-ui="enabled: true">
  <a-sky id="sky" radius="10"></a-sky>
  <a-entity camera look-controls></a-entity>
</a-scene>

<script>
/* ========= 設定 ========= */
const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSc7bClpct_WSlABMw2oSgxIvqLSIBBuCK_s9rOElQB025EAZw/viewform";

// あなたのHDRファイル（ルート直下）
let IMAGES = [
  '1.hdr','8.hdr','15.hdr','22.hdr','29.hdr','36.hdr',
  '43.hdr','50.hdr','57.hdr','64.hdr','71.hdr','78.hdr',
  '85.hdr','92.hdr','99.hdr','106.hdr'
];

/* ======== 便利関数 ======== */
const $ = sel => document.querySelector(sel);
function log(msg){ const el = $('#log'); el.textContent = (el.textContent || 'log:') + "\\n" + msg; console.log(msg); }

// Fisher–Yates シャッフル（シード任意）
function shuffle(arr, seedStr){
  const a = [...arr];
  let rnd = Math.random;
  if (seedStr && seedStr.trim() !== '') {
    // FNV風の簡易ハッシュ → xorshift
    let h = 2166136261; for (let i=0;i<seedStr.length;i++){ h ^= seedStr.charCodeAt(i); h = Math.imul(h,16777619); }
    let x = h>>>0;
    rnd = ()=>{ x^=x<<13; x>>>=0; x^=x>>>17; x>>>=0; x^=x<<5; x>>>=0; return (x>>>0)/0xFFFFFFFF; };
  }
  for (let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}

/* ======== 状態 ======== */
let pid = '';
let order = [];
let idx = -1;
let lockSec = 10;
let sceneReady = false;

/* ======== HDR適用 ======== */
function setSky(src){
  const sky = $('#sky');
  const sceneEl = document.querySelector('a-scene');
  const sceneObj = sceneEl.object3D;
  const isHDR = /\.hdr$/i.test(src);
  const isEXR = /\.exr$/i.test(src);

  // 旧背景の破棄
  try{
    if (sceneObj.background && sceneObj.background.dispose) sceneObj.background.dispose();
  }catch(e){}

  if (isHDR || isEXR){
    sky.setAttribute('visible', false);
    const loader = isEXR ? new THREE.EXRLoader() : new THREE.RGBELoader();
    loader.setDataType(THREE.UnsignedByteType);
    log('loading HDR: '+src);
    loader.load(src, (tex)=>{
      tex.mapping = THREE.EquirectangularReflectionMapping;
      tex.needsUpdate = true;
      sceneObj.background = tex;
      log('✅ HDR applied: '+src);
    }, undefined, (err)=>{
      log('❌ HDR load error: '+src);
      console.error(err);
      // フォールバック（LDR系を想定）
      sceneObj.background = null;
      sky.setAttribute('visible', true);
      sky.setAttribute('src', '');
    });
  }else{
    sceneObj.background = null;
    sky.setAttribute('visible', true);
    sky.setAttribute('src', src);
  }
}

/* ======== 進行制御 ======== */
function startExperiment(){
  pid = $('#pid').value.trim();
  if (!pid){ alert('被験者IDを入力してください'); return; }
  lockSec = parseInt($('#lock').value,10)||10;

  const seedStr = $('#seed').value.trim();
  order = shuffle(IMAGES, seedStr);
  $('#total').textContent = String(order.length);

  $('#ui').style.display='none';

  // シーンが完全にreadyになってから最初のHDRを適用
  const go = ()=>{ if (sceneReady){ nextImage(); } else { setTimeout(go, 100); } };
  go();
}

function nextImage(){
  idx++;
  if (idx >= order.length){
    alert('完了しました。ご協力ありがとうございました。');
    return;
  }
  const src = order[idx];
  log(`show ${idx+1}/${order.length}: ${src}`);
  setSky(src);

  // lock → フォームを別タブで開く → オーバーレイ提示
  setTimeout(()=>{
    window.open(GOOGLE_FORM_URL, '_blank');  // モバイル/Questでも安定
    $('#nextOverlay').style.display='flex';
  }, lockSec*1000);
}

function continueToNext(){
  $('#nextOverlay').style.display='none';
  nextImage();
}

/* ======== イベント登録 ======== */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#start').addEventListener('click', startExperiment);
  $('#nextBtn').addEventListener('click', continueToNext);

  // URLクエリで pid/seed/lock 事前指定可
  const usp=new URLSearchParams(location.search);
  if (usp.get('pid')) $('#pid').value = usp.get('pid');
  if (usp.get('seed')) $('#seed').value = usp.get('seed');
  if (usp.get('lock')) $('#lock').value = usp.get('lock');

  // A-Frameシーンの ready を待つ
  const sceneEl = document.querySelector('a-scene');
  sceneEl.addEventListener('loaded', ()=>{ sceneReady = true; log('scene loaded'); });
});
</script>

</body>
</html>
