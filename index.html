<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VR Experiment</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- HDR / EXR Loaders (three.js r152系 = A-Frame1.5.0と相性が良い) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/RGBELoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/EXRLoader.js"></script>

  <style>
    #ui {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      color: white;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-size: 1.4rem;
      z-index: 9999;
    }
    button {
      padding: 12px 24px;
      background: #3a7; color: white;
      border: none; border-radius: 6px;
      font-size: 1.2rem;
      cursor: pointer;
      margin-top: 1rem;
    }
  </style>
</head>

<body>
<div id="ui">
  <div>参加者ID（PID）を入力してください：</div>
  <input id="pidInput" style="font-size:1.2rem; padding:6px; margin-top:10px;">
  <button onclick="startExperiment()">開始</button>
</div>

<div id="nextOverlay" style="display:none; position:fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);color:white;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:1.4rem;">Googleフォームに回答して送信してください。</div>
  <div style="font-size:1.1rem; margin-top:10px;">送信が終わったら、下のボタンを押すと次の画像に進みます。</div>
  <button onclick="continueToNext()">次へ</button>
</div>

<a-scene>
  <a-sky id="sky" radius="10"></a-sky>
  <a-entity camera look-controls></a-entity>
</a-scene>

<script>
/* ✅ GoogleフォームURL */
const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSc7bClpct_WSlABMw2oSgxIvqLSIBBuCK_s9rOElQB025EAZw/viewform";

/* ✅ HDR画像（あなたのデータに合わせ済） */
let IMAGES = [
  '1.hdr','8.hdr','15.hdr','22.hdr','29.hdr','36.hdr',
  '43.hdr','50.hdr','57.hdr','64.hdr','71.hdr','78.hdr',
  '85.hdr','92.hdr','99.hdr','106.hdr'
];

/* ✅ ランダムシャッフル */
IMAGES = IMAGES.sort(()=>Math.random()-0.5);

let currentIndex = 0;
let pid = "";

/* ✅ HDR ロード対応表示関数 */
function setSky(src) {
  const sky = document.querySelector("#sky");
  const sceneObj = document.querySelector('a-scene').object3D;
  const isHDR = /\.hdr$/i.test(src);
  const isEXR = /\.exr$/i.test(src);

  // 前の背景を破棄
  try {
    if(sceneObj.background && sceneObj.background.dispose){
      sceneObj.background.dispose();
    }
  }catch(e){}

  if(isHDR || isEXR){
    sky.setAttribute('visible', false);
    const loader = isEXR ? new THREE.EXRLoader() : new THREE.RGBELoader();
    loader.setDataType(THREE.UnsignedByteType);
    loader.load(src, (texture)=>{
      texture.mapping = THREE.EquirectangularReflectionMapping;
      sceneObj.background = texture;
    });
  } else {
    sceneObj.background = null;
    sky.setAttribute('visible', true);
    sky.setAttribute('src', src);
  }
}

/* ✅ 実験開始 */
function startExperiment() {
  pid = document.getElementById("pidInput").value.trim();
  if(!pid){ alert("PIDを入力してください"); return; }

  document.getElementById("ui").style.display = "none";
  showImage();
}

/* ✅ 画像を表示し、10秒後にフォーム */
function showImage() {
  if(currentIndex >= IMAGES.length){
    alert("実験終了です。お疲れさまでした！");
    return;
  }
  setSky(IMAGES[currentIndex]);

  setTimeout(()=>{
    window.open(GOOGLE_FORM_URL, "_blank");
    document.getElementById("nextOverlay").style.display = "flex";
  }, 10000);
}

/* ✅ 「次へ」 */
function continueToNext() {
  document.getElementById("nextOverlay").style.display="none";
  currentIndex++;
  showImage();
}
</script>

</body>
</html>
