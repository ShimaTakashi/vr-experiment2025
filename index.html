<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VR Experiment (HDR fully robust)</title>

  <!-- A-Frame (THREEã‚’å†…åŒ…) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- three r152ç³» ã® HDR/EXR ãƒ­ãƒ¼ãƒ€ï¼ˆA-Frame 1.5.0 ã¨ç›¸æ€§â—ï¼‰-->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/RGBELoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/EXRLoader.js"></script>

  <style>
    html,body{margin:0;height:100%;background:#000;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", Meiryo, sans-serif}
    #ui,#next{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.85);color:#fff;z-index:9999}
    #ui input,#ui select{font-size:1.05rem;padding:.6rem .9rem;border-radius:.6rem;border:1px solid #444;background:#111;color:#fff}
    button{padding:.8rem 1.4rem;border:1px solid #666;background:#1a7f5a;color:#fff;border-radius:.6rem;font-size:1.05rem;cursor:pointer}
    #log{position:fixed;left:10px;bottom:10px;color:#0f0;background:rgba(0,0,0,.6);padding:.44rem .6rem;border-radius:.4rem;font:12px/1.3 monospace;z-index:10000;max-width:72vw;white-space:pre-wrap}
  </style>
</head>
<body>

<!-- ã‚¹ã‚¿ãƒ¼ãƒˆUI -->
<div id="ui">
  <h2>360Â° æç¤º + ãƒ•ã‚©ãƒ¼ãƒ è©•ä¾¡ï¼ˆHDRå¯¾å¿œï¼‰</h2>
  <p style="text-align:center;opacity:.85">
    1æšç›®ã®æç¤ºã‹ã‚‰ <b>10ç§’å¾Œ</b> ã«Googleãƒ•ã‚©ãƒ¼ãƒ ãŒé–‹ãã¾ã™ã€‚<br>
    é€ä¿¡å¾Œã«ã€Œæ¬¡ã¸ã€ã‚’æŠ¼ã™ã¨æ¬¡ã®ç”»åƒã¸ã€‚å…¨ <span id="total">16</span> æ¡ä»¶ã€‚
  </p>
  <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
    <div><div>è¢«é¨“è€…ID</div><input id="pid" placeholder="ä¾‹: S001"></div>
    <div><div>ä¹±æ•°ã‚·ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</div><input id="seed" placeholder="æœªå…¥åŠ›ãªã‚‰è‡ªå‹•"></div>
    <div><div>ãƒ­ãƒƒã‚¯ç§’</div>
      <select id="lock">
        <option value="10" selected>10ç§’</option>
        <option value="15">15ç§’</option>
        <option value="20">20ç§’</option>
      </select>
    </div>
  </div>
  <div style="margin-top:16px"><button id="start">é–‹å§‹</button></div>
  <small style="opacity:.7;margin-top:10px">Quest ãƒ–ãƒ©ã‚¦ã‚¶ã§å…¨ç”»é¢ã«ã—ã¦å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚</small>
</div>

<!-- å›ç­”ä¿ƒã—UI -->
<div id="next" style="display:none">
  <div style="text-align:center">
    <div style="font-size:1.15rem">Googleãƒ•ã‚©ãƒ¼ãƒ ã«å›ç­”ã—ã€<b>é€ä¿¡</b>ã—ã¦ãã ã•ã„ã€‚</div>
    <div style="opacity:.8;margin:.6rem 0 .9rem">é€ä¿¡å¾Œã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ¬¡ã®ç”»åƒã¸</div>
    <button id="nextBtn">æ¬¡ã¸</button>
  </div>
</div>

<!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° -->
<div id="log">log:</div>

<!-- ã‚·ãƒ¼ãƒ³ï¼ˆHDRãŒæ˜ ãˆã‚‹è¨­å®šï¼‰ -->
<a-scene
  renderer="colorManagement:true; physicallyCorrectLights:true; toneMapping:ACESFilmic; toneMappingExposure:1.0"
  vr-mode-ui="enabled:true">
  <a-sky id="sky" radius="10"></a-sky>
  <a-entity camera look-controls></a-entity>
</a-scene>

<script>
/* ========= è¨­å®š ========= */
const GOOGLE_FORM_URL =
  "https://docs.google.com/forms/d/e/1FAIpQLSc7bClpct_WSlABMw2oSgxIvqLSIBBuCK_s9rOElQB025EAZw/viewform";

/* ã‚ãªãŸã®HDRï¼ˆãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹é…ç½®ï¼‰ */
let IMAGES = [
  '1.hdr','8.hdr','15.hdr','22.hdr','29.hdr','36.hdr',
  '43.hdr','50.hdr','57.hdr','64.hdr','71.hdr','78.hdr',
  '85.hdr','92.hdr','99.hdr','106.hdr'
];

/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const $ = s => document.querySelector(s);
function log(m){ const el=$('#log'); el.textContent += "\n"+m; console.log(m); }
window.addEventListener('error', e=>log('âš  JS Error: '+e.message));

function shuffle(arr, seedStr){
  const a=[...arr]; let rnd=Math.random;
  if (seedStr && seedStr.trim()!==''){
    let h=2166136261; for (let i=0;i<seedStr.length;i++){ h^=seedStr.charCodeAt(i); h=Math.imul(h,16777619); }
    let x=h>>>0; rnd=()=>{ x^=x<<13; x>>>=0; x^=x>>>17; x>>>=0; x^=x<<5; x>>>=0; return (x>>>0)/0xFFFFFFFF; };
  }
  for (let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}

/* ========= çŠ¶æ…‹ ========= */
let pid='', order=[], idx=-1, lockSec=10, sceneReady=false;

/* ========= HDRé©ç”¨ï¼ˆå®Œå…¨ç‰ˆï¼‰ ========= */
async function setHDR(src){
  const sceneObj = document.querySelector('a-scene').object3D;
  const sky = $('#sky');
  const isHDR=/\.hdr$/i.test(src), isEXR=/\.exr$/i.test(src);

  // äº‹å‰ãƒ•ã‚§ãƒƒãƒï¼ˆ404/CORSæ¤œçŸ¥ï¼‰
  try{
    const r = await fetch(src,{method:'GET'});
    if(!r.ok){ log(`âŒ fetch NG (${r.status}) ${src}`); }
    else { log(`fetch OK ${src} (${r.headers.get('content-type')||''})`); }
  }catch(e){ log(`âŒ fetch error ${src}: `+e.message); }

  // æ—§èƒŒæ™¯ç ´æ£„
  try{ if(sceneObj.background && sceneObj.background.dispose) sceneObj.background.dispose(); }catch(e){}

  if(!(isHDR||isEXR)){
    // LDRãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼ˆä»Šå›ã¯ä½¿ã‚ãªã„æƒ³å®šï¼‰
    sceneObj.background=null; sky.setAttribute('visible',true); sky.setAttribute('src',src);
    return;
  }

  sky.setAttribute('visible', false);

  // ğŸ”‘ ãƒ­ãƒ¼ãƒ€å‚ç…§ï¼ˆwindow.* / THREE.* ä¸¡å¯¾å¿œï¼‰
  const RGBE = window.RGBELoader || (window.THREE && THREE.RGBELoader);
  const EXR  = window.EXRLoader  || (window.THREE && THREE.EXRLoader);
  const LoaderClass = isEXR ? EXR : RGBE;

  if(!LoaderClass){ log('âŒ Loader not found on window.* nor THREE.*'); return; }

  // å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ï¼šæŒ‡å®šãƒ‡ãƒ¼ã‚¿å‹ã§èª­ã¿è¾¼ã¿
  const tryLoad = (dataType, label) => new Promise((resolve,reject)=>{
    const loader = new LoaderClass();
    if (loader.setDataType) loader.setDataType(dataType);
    log(`loading (${label}) ${src}`);
    loader.load(src, (tex)=>{
      tex.mapping = THREE.EquirectangularReflectionMapping;
      tex.needsUpdate = true;
      sceneObj.background = tex;
      log(`âœ… applied (${label}) ${src}`);
      resolve();
    }, undefined, (err)=>{ log(`âš  load error (${label}) ${src}`); reject(err); });
  });

  // HalfFloat â†’ UnsignedByte ã®é †ã§è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  try{
    await tryLoad(THREE.HalfFloatType, 'HalfFloat');
  }catch(_){
    try{
      await tryLoad(THREE.UnsignedByteType, 'UnsignedByte');
    }catch(e2){
      log('âŒ both loaders failed: '+src);
      console.error(e2);
      sceneObj.background=null; sky.setAttribute('visible',true); sky.setAttribute('src','');
    }
  }
}

/* ========= æµã‚Œ ========= */
function nextImage(){
  idx++;
  if(idx>=order.length){ alert('å®Œäº†ã—ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚'); return; }
  const src = order[idx];
  log(`show ${idx+1}/${order.length}: ${src}`);
  setHDR(src).then(()=>{
    setTimeout(()=>{
      window.open(GOOGLE_FORM_URL,'_blank');
      $('#next').style.display='flex';
    }, lockSec*1000);
  });
}

function startExperiment(){
  pid = $('#pid').value.trim(); if(!pid){ alert('è¢«é¨“è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  lockSec = parseInt($('#lock').value,10) || 10;
  order = shuffle(IMAGES, $('#seed').value.trim());
  $('#total').textContent = String(order.length);
  $('#ui').style.display='none';
  const go=()=>{ if(sceneReady) nextImage(); else setTimeout(go,120); }; go();
}

function continueToNext(){ $('#next').style.display='none'; nextImage(); }

/* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#start').addEventListener('click', startExperiment);
  $('#nextBtn').addEventListener('click', continueToNext);

  const sceneEl=document.querySelector('a-scene');
  sceneEl.addEventListener('loaded',()=>{ sceneReady=true; log('scene loaded'); });

  // URLã‚¯ã‚¨ãƒªæŒ‡å®šå¯¾å¿œ
  const q=new URLSearchParams(location.search);
  if(q.get('pid'))  $('#pid').value=q.get('pid');
  if(q.get('seed')) $('#seed').value=q.get('seed');
  if(q.get('lock')) $('#lock').value=q.get('lock');
});
</script>
</body>
</html>
